---
title: "Problem Set 1"
author: "Anaya Hall"
output: github_document
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(cache = T)
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
```

***

## ARE 212 - Problem Set #1
Due Feb. 7, 2017  

***

### PART 1: Theory 

*Practice Only*

***

### PART 2: Applied - Carbon & Income

#####1. Download World Bank’s **World Development Indicators** (from Data Center): <http://databank.worldbank.org/data/reports.aspx?source=world-development-indicators>
Downloaded Jan. 27, 2018. 

#####2. Load data into R

```{r message=FALSE}

rm(list = ls())
mydir <- "~/projects/are212/pset1/"
datadir <- "wdi/"

# Bring in Data
setwd(mydir)
wdi_rawdata <- readr::read_csv(paste0(mydir,datadir,"wdi_carbon_income.csv"), na = ("..")
                            )
#Reshape data long to wide
wdi_df <- as.data.frame(wdi_rawdata)
wide <- reshape(wdi_df, idvar = c("Country Name", "Country Code"), timevar="Series Name", 
                drop = "Series Code", direction = "wide")

#Remove empty column of YEAR
wide <- wide[(-6)]

#Remove incomplete observations
wide <- na.omit(wide)

#Should be 194 countries. Check!
wdi_data <- rename(wide, CO2 = "2010 [YR2010].CO2 emissions (kt)", 
                  GDP =  "2010 [YR2010].GDP (constant 2010 US$)", 
                 POP = "2010 [YR2010].Population, total")

```

There are 194 countries with complete observations for the three series of interest. 

#####3. Calculate a table of showing the sample mean, standard deviation, minimum and maximum for each series:


```{r results = 'hide', message=FALSE}
summary(wdi_data)
sapply(wdi_data, sd)
```

Series      | CO2 (kt)      |  GDP (Billion USD (2010))   | POP (persons)    |
------------- | ------------- | ------------- | ------------- | 
Mean          | 162317        | 3.364e+11     | 3.522e+07
SD            | 7.630124e+05  | 1.297364e+12  | 1.346430e+08
Min           | 7             | 3.182e+07     | 1.002e+04 
Max           | 8776040       | 1.496e+13     | 1.338e+09


#####4. Create a histogram for CO2 and GDP (15 buckets).

```{r pressure}
hist(wdi_data$CO2, breaks=15)
```


```{r}
hist(wdi_data$GDP, breaks=15)
```

```{r echo=FALSE}

ggplot(data=wdi_data, aes(x= GDP, y = CO2)) + geom_point() + ylab("CO2 Emissions (kt)") + xlab("GDP (Billions of USD 2010)") + labs(title="CO2 emissions vs GDP by Country (2010)")


```
  

#####6. Create new variable “Per capita CO2 emissions” called CO2pc.

```{r}
wdi_data$CO2pc <- wdi_data$CO2/wdi_data$POP
```

#####7. Create a new variable “Per capita GDP” GDPpc.

```{r}
wdi_data$GDPpc <- wdi_data$GDP/wdi_data$POP
```

#####8. Plot CO2pc against GDPpc.

```{r echo=FALSE}

ggplot(data=wdi_data, aes(x= GDPpc, y = CO2pc)) + geom_point() + ylab("Per capita CO2 Emissions (kt)") + xlab("Per capita GDP (Billions of USD 2010)") + labs(title="Per Capita CO2 emissions vs Per Captia GDP (2010)")

```

#####9. Create demeaned variables of CO2pc and GDPpc called CO2pcdev and GDPpcdev by subtracting the sample mean from each observation.

```{r}
#Get sample mean of per capita CO2 emissions
co2mean <- mean(wdi_data$CO2pc)
#Calculate deviance for each observation
wdi_data$CO2pcdev <- wdi_data$CO2pc - co2mean

#Get sample mean of per capita GDP
gdpmean <- mean(wdi_data$GDPpc)
#Calculate deviance for each obs
wdi_data$GDPpcdev <- wdi_data$GDPpc - gdpmean
```


#####10. Plot CO2pcdev against GDPpcdev.

```{r echo=FALSE}

ggplot(data=wdi_data, aes(x= GDPpcdev, y = CO2pcdev)) + geom_point() + ylab("Per capita CO2 Emissions (kt)") + xlab("Per capita GDP (USD 2010)") + labs(title="Demeaned CO2 vs Demeaned GDP by Country (2010)")

```

#####11. Create the variables CO2pcln and GDPpcln by taking natural logs of CO2pc and GDPpc.

```{r}

#Natural log of CO2pc
wdi_data$CO2pcln <- log(wdi_data$CO2pc)

#Natural log of GDPpc
wdi_data$GDPpcln <- log(wdi_data$GDPpc)

```

#####12. Plot CO2pcln and GDPpcln.

```{r}

ggplot(data=wdi_data, aes(x= GDPpcln, y = CO2pcln)) + geom_point() + ylab("Log Per capita CO2 Emissions (kt)") + xlab("Log Per capita GDP (USD 2010)") + labs(title="Logged CO2 Emissions vs Logged GDP by Country")

```


#####13. Export your data as a comma delimited ascii file.

```{r}

write.csv(wdi_data, "wdi_data.csv")

```

***

#####14. Regress CO2pc on GDPpc without an intercept. 

```{r}

# Function to calculate beta coefficient without an intercept 
b_ols <- function(data, y, X, include_i) {
  # Require the 'dplyr' package
  require(dplyr)
  
  # Create the y matrix
  y_data <- data %>%
    # Select y variable data from 'data'
    select_(.dots = y) %>%
    #if(include_i)
    # Convert y_data to matrices
    as.matrix()
  
  # Select X variable data from 'data'
  X_data <- select_(data, .dots = X)
  # Convert X_data to matrices
  X_data <- as.matrix(X_data)
  # Add a column of ones to front
  if(include_i) {X_data <- cbind(1, X_data)
  colnames(X_data)[1] <- "ones"}
  
  # Calculate beta hat
  beta_hat <- solve(t(X_data) %*% X_data) %*% t(X_data) %*% y_data
  # Change the name of 'ones' to 'intercept'
  if(include_i){
      rownames(beta_hat) <- c("intercept", X)
  }
  else
    rownames(beta_hat) <- c(X)

  n <- nrow(X_data)
  k <- ncol(X_data)
  
  dof <- n - k 
  
  #uncentered R2
  e <- (diag(n) - X_data %*% solve(t(X_data) %*% X_data) %*% t(X_data)) %*% y_data
  ruc_sq <- (1- ((t(e) %*% e)) / (t(y_data) %*% y_data))
  
  #centered R2
  i <- rep(1, n)
  A <- (diag(i) - (1/n)*(i) %*% t(i))
  y_star = A %*% y_data
  r_sq <- 1 - ( (t(e) %*% e) / (t(y_star) %*% y_star) )
  
  #Adjusted R2
  adj_r2 <- 1 - (((n-1)/(n-k))*(1-r_sq))
  
  #AIC
  aic <- log((t(e) %*% e)/n) + 2*(k/n)
  
  #SIC
  sic <- log((t(e) %*% e)/n) + (k/n)*(log(n))

  # s2
  s2 <- (t(e) %*% e)/(n-k)
  
  #residuals
  # res <- 
  
  reg_list <- c("Beta_hat" = beta_hat, "n" = n, "dof" = dof, "ruc_sq" = ruc_sq, "r_sq" = r_sq, "Adj_R2" = adj_r2, "AIC" = aic, "SIC" = sic, "s2" = s2)
  
  return(reg_list)
  
  }

# Regress CO2pc on GDPpc without an intercept
b_ols(data=wdi_data, y="CO2pc", X="GDPpc", include_i = FALSE)

```


######Write down your regression coefficient. 

*Regression coefficient: 2.233062e-07*

Now multiply CO2pc by 1000, changing its units to tons instead of kilotons. Run the regression again. 

```{r}

wdi_data$CO2pc_tons <- wdi_data$CO2pc*1000 #Change units of per capita CO2 conc to tons

# Rerun regression
b_ols(data=wdi_data, y="CO2pc_tons", X="GDPpc", include_i = FALSE)

```

######What has happened to the coefficient on GDPpc? 

*Coefficient GDPpc is now 0.0002233062, four orders of magnitude larger*

Now divide GDPpc by 1000, changing its units to thousands of $ instead of $. Run the regression again.

```{r}

wdi_data$GDPpc_thous <- wdi_data$GDPpc*(1/1000)

b_ols(data=wdi_data, y="CO2pc_tons", X="GDPpc_thous", include_i = FALSE)

```


######What has happened to the coefficient on GDPpc? (Optional: Calculate the R2 for each regression and see what happens. Any changes? What happens to the sums of squares?) Keep both variables in the new units.

*Coefficient is now 0.2233062, four more orders of magnitude larger*

#####15. For the last regression from the previous part calculate and report n, degrees of freedom, b, Ru2c, R2, R ̄2, AIC, SIC, s2.  

```{r}

b_ols(data=wdi_data, y="CO2pc_tons", X="GDPpc_thous", include_i = FALSE)

```


Then calculate the predicted values and plot them against the actual CO2pc. Calculate your residuals and plot them against GDPpc. Do not submit the graphs, but briefly talk about what these figures tell you about fit and the validity of the constant variance assumption. Also - are there any outliers?


```{r}

# calculate the predicted values and plot them against the actual CO2pc. Calculate your residuals and plot them against GDPpc
# plot
```


*what these figures tell you about fit and the validity of the constant variance assumption. Also - are there any outliers?*



#####16. Regress CO2pc on GDPpc and an intercept. 
Calculate and report n, df = n − k, b, Ru2c, R2, R ̄2, AIC, SIC, s2. Then calculate the predicted values and plot them against CO2pc. Calculate your residuals and plot them against GDPpc. Do not submit the graphs. Use the pictures and results to talk about how the fit has improved or not.


```{r include=FALSE}

b_ols(data=wdi_data, y="CO2pc_tons", X="GDPpc_thous", include_i = TRUE)

# calculate the predicted values and plot them against CO2pc. Calculate your residuals and plot them against GDPpc

```
*HAS the fit improved??*


#####17. Regress CO2pc on an intercept, GDPpc and GDPpc2, where GDPpc2 is the square of GNIpc. 
Calculate and report n, degrees of freedom, b, Ru2c, R2, R ̄2, AIC, SIC, s2. Then calculate the predicted values and plot them against CO2pc. Calculate your residuals and plot them against GDPpc. Do not submit the graphs. Use the pictures and results to talk about how the fit has improved or not. Also briefly address whether including GDPpc2 in the regression is violates any of our assumptions. Does this specification make economic sense?


```{r}

wdi_data$GDPpc2 <- wdi_data$GDPpc^2

b_ols(data=wdi_data, y="CO2pc", X=c("GDPpc", "GDPpc2") , include_i = FALSE)

# Calculate RESIDUALS
# plot()

```
*Does not violate our assumptions, but is hard to interpret*

#####18. The power of FWT. 
Calculate demeaned versions of CO2pc, GDPpc and GDPpc2. Regress the demeaned CO2pc on the demeaned GDPpc and GDPpc2. Compare your parameter estimates to the result from the previous part.

```{r}
#see notes from stata
```


#####19. More power of FWT. 
Regress CO2pc on GDPpc. Save your residuals. Now regress the columns of [i GDPpc2] on GDPpc. Save your residuals (an n × 2 matrix of residuals). Now regress the first vector of n residuals on the (n × 2) matrix of residuals. Report your findings.

```{r}

```






